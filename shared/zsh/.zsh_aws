# AWS Power Functions for Zsh
# Enhanced by Gemini

# ==============================================================================
# Configuration & Core Functions
# ==============================================================================

# Unalias existing aws aliases to prevent conflicts
unalias aws_check_profile aws_list_profiles aws_use_profile aws_ssm_session 2>/dev/null

# Centralized function to manage AWS profile and region for commands
# Usage: _aws_env [--profile <p>] [--region <r>]
# It sets the correct AWS_PROFILE and AWS_REGION for the command to be executed.
_aws_env() {
    export _AWS_PROFILE=${AWS_PROFILE:-default}
    export _AWS_REGION=${AWS_REGION:-$(aws configure get region 2>/dev/null || echo "us-east-1")}

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --profile)
                export _AWS_PROFILE="$2"
                shift 2
                ;; 
            --region)
                export _AWS_REGION="$2"
                shift 2
                ;; 
            *)
                # Preserve other arguments
                shift
                ;; 
esac
    done
}

# Wrapper for all AWS CLI calls to automatically handle profile and region
aws() {
    command aws --profile "$_AWS_PROFILE" --region "$_AWS_REGION" "$@"
}

# ==============================================================================
# Profile & Session Management
# ==============================================================================

# List available AWS profiles from ~/.aws/config and ~/.aws/credentials
aws_list_profiles() {
    _aws_env "$@"
    echo "üë§ Available AWS Profiles:"
    profiles=$( (grep '[[profile ' ~/.aws/config | sed 's/[[profile \(.*\)]/\1/') & grep '[[.*]]' ~/.aws/credentials | sed 's/[[\(.*\)]/\1/') | sort -u)
    
    if [[ -z "$profiles" ]]; then
        echo "   No profiles found."
        return
    fi
    
    while read -r profile; do
        if [[ "$profile" == "$_AWS_PROFILE" ]]; then
            echo "   [bold green]‚úì $profile (active)[/bold green]"
        else
            echo "     $profile"
        fi
done <<< "$profiles"
}

# Switch active AWS profile
aws_use_profile() {
    _aws_env "$@"
    if [[ -z "$1" ]]; then
        echo "Usage: aws_use_profile <profile_name>"
        aws_list_profiles
        return 1
    fi
    export AWS_PROFILE="$1"
    echo "‚úÖ Switched to AWS profile: [bold cyan]$AWS_PROFILE[/bold cyan]"
    aws_check_profile
}

# Check the status of the current or specified profile
aws_check_profile() {
    _aws_env "$@"
    echo "\nüîç Checking status for profile: [bold cyan]$_AWS_PROFILE[/bold cyan] in region [bold cyan]$_AWS_REGION[/bold cyan]..."
    
    if ! aws sts get-caller-identity --query "Account" --output text &>/dev/null; then
        echo "[bold red]Error:[/] Failed to authenticate with profile '$_AWS_PROFILE'."
        echo "Please check your credentials or run 'aws configure --profile $_AWS_PROFILE'."
        return 1
    fi
    
    local identity=$(aws sts get-caller-identity)
    local account=$(echo "$identity" | jq -r .Account)
    local user_id=$(echo "$identity" | jq -r .UserId)
    local arn=$(echo "$identity" | jq -r .Arn)
    
    echo "[bold green]‚úì Authentication successful![/bold green]"
    echo "   [bold]Account:[/bold] $account"
    echo "   [bold]UserID:[/bold]  $user_id"
    echo "   [bold]ARN:[/bold]     $arn"
}

# ==============================================================================
# EC2 Instance Management
# ==============================================================================

# List EC2 instances with a clean, readable table format
aws_ec2_instances() {
    _aws_env "$@"
    echo "Listing EC2 instances in region [bold cyan]$_AWS_REGION[/bold cyan]..."
    
    aws ec2 describe-instances --query 'Reservations[*].Instances[*].[InstanceId,InstanceType,State.Name,PublicIpAddress,PrivateIpAddress,Tags[?Key==`Name`].Value|[0]]' --output text | column -t -s $'	' | sed '1s/^/ID\tTYPE\tSTATE\tPUBLIC_IP\tPRIVATE_IP\tNAME\n/'
}

# Start an interactive SSM session with an EC2 instance
aws_ssm_session() {
    _aws_env "$@"
    if [[ -z "$1" ]]; then
        echo "Usage: aws_ssm_session <instance_id>"
        echo "Starts an interactive shell session with an EC2 instance using SSM."
        aws_ec2_instances "$@"
        return 1
    fi
    
    local instance_id="$1"
    echo "Starting SSM session with [bold cyan]$instance_id[/bold cyan]..."
    aws ssm start-session --target "$instance_id"
}

# ==============================================================================
# S3 Bucket Management
# ==============================================================================

# A more user-friendly 'ls' for S3 buckets and objects
aws_s3_ls() {
    _aws_env "$@"
    local s3_path="$1"
    
    if [[ -z "$s3_path" ]]; then
        echo "Listing all S3 buckets..."
        aws s3 ls
        return
    fi

    # Ensure path ends with a slash if it's a "directory"
    if [[ "$s3_path" != */ && -n "$s3_path" ]]; then
        if aws s3 ls "$s3_path/" &>/dev/null; then
            s3_path="$s3_path/"
        fi
    fi
    
    echo "Listing contents of [bold cyan]$s3_path[/bold cyan]..."
    aws s3 ls "$s3_path"
}

# ==============================================================================
# CloudWatch Logs
# ==============================================================================

# Fetch and follow logs from a CloudWatch log group
aws_cw_logs() {
    _aws_env "$@"
    if [[ -z "$1" ]]; then
        echo "Usage: aws_cw_logs <log_group_name> [--follow]"
        echo "\nAvailable log groups:"
        aws logs describe-log-groups --query 'logGroups[*].logGroupName' --output text | tr '\t' '\n'
        return 1
    fi
    
    local log_group="$1"
    local follow_flag=""
    if [[ "$2" == "--follow" ]]; then
        follow_flag="--follow"
    fi
    
    echo "Fetching logs for [bold cyan]$log_group[/bold cyan]..."
    aws logs tail "$log_group" $follow_flag
}


# ==============================================================================
# Help & Initialization
# ==============================================================================

aws_help() {
    echo "[bold green]AWS Power Functions for Zsh[/bold green]"
    echo "A collection of helper functions to make working with the AWS CLI easier."
    echo ""
    echo "[bold]Profile & Session Management:[/bold]"
    echo "  [cyan]aws_list_profiles[/cyan]              - List all configured AWS profiles."
    echo "  [cyan]aws_use_profile <profile>[/cyan]     - Switch the active AWS profile for the current session."
    echo "  [cyan]aws_check_profile[/cyan]              - Check authentication status for the current profile."
    echo ""
    echo "[bold]EC2 Instance Management:[/bold]"
    echo "  [cyan]aws_ec2_instances[/cyan]              - List EC2 instances with a clean, readable table format."
    echo "  [cyan]aws_ssm_session <instance_id>[/cyan] - Start an interactive SSM session with an instance."
    echo ""
    echo "[bold]S3 Bucket Management:[/bold]"
    echo "  [cyan]aws_s3_ls [s3://path][/cyan]          - List S3 buckets or objects in a bucket."
    echo ""
    echo "[bold]CloudWatch Logs:[/bold]"
    echo "  [cyan]aws_cw_logs <group> [--follow][/cyan]- Fetch and optionally follow logs from a CloudWatch log group."
    echo ""
    echo "[bold]Note:[/bold] Most commands accept [cyan]--profile <p>[/cyan] and [cyan]--region <r>[/cyan] arguments."
}

# Initial message to let the user know the functions are loaded.
echo "‚ö°Ô∏è AWS Power Functions loaded. Type 'aws_help' for a list of commands."

# Set default environment
_aws_env
